<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>经济学测验集合</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      svg: {
        fontCache: 'global'
      },
      startup: {
        ready: () => {
          MathJax.startup.defaultReady();
          // 通知组件MathJax已准备好
          window.MathJaxReady = true;
          if (window.onMathJaxReady) window.onMathJaxReady();
        }
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Noto Sans SC', system-ui, sans-serif; background: #f3f4f6; min-height: 100vh; }

    .home-page { min-height: 100vh; padding: 24px; }
    .home-header { max-width: 896px; margin: 0 auto 48px; padding-top: 32px; }
    .home-title { font-size: 48px; font-weight: 900; margin-bottom: 16px; }
    .home-subtitle { font-size: 20px; color: #6b7280; font-weight: 500; }
    .quiz-grid { max-width: 896px; margin: 0 auto; display: grid; gap: 24px; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }
    .quiz-card { border: 3px solid #000; box-shadow: 6px 6px 0 0 #000; padding: 24px; cursor: pointer; transition: all 0.15s ease; background: #fff; }
    .quiz-card:hover { box-shadow: 8px 8px 0 0 #000; transform: translate(-2px, -2px); }
    .quiz-card.locked { opacity: 0.5; pointer-events: none; }
    .quiz-tag { display: inline-block; padding: 4px 12px; border: 2px solid #000; font-size: 12px; font-weight: 800; text-transform: uppercase; margin-bottom: 16px; }
    .quiz-tag.slate { background: #94a3b8; color: #fff; }
    .quiz-tag.yellow { background: #facc15; }
    .quiz-tag.purple { background: #c084fc; }
    .quiz-tag.blue { background: #60a5fa; }
    .quiz-tag.green { background: #4ade80; }
    .quiz-tag.orange { background: #fb923c; }
    .quiz-tag.red { background: #f87171; color: #fff; }
    .quiz-tag.pink { background: #f472b6; color: #fff; }
    .quiz-tag.cyan { background: #22d3d8; }
    .quiz-tag.indigo { background: #818cf8; color: #fff; }
    .quiz-tag.violet { background: #a78bfa; color: #fff; }
    .quiz-tag.amber { background: #fbbf24; }
    .quiz-tag.lime { background: #a3e635; }
    .quiz-tag.teal { background: #2dd4bf; }
    .quiz-tag.rose { background: #fb7185; color: #fff; }
    .quiz-tag.gray { background: #9ca3af; }
    .quiz-tag.stone { background: #78716c; color: #fff; }
    .quiz-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
    .quiz-desc { color: #6b7280; font-weight: 500; }
    .quiz-tags { margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap; }
    .tag { padding: 2px 8px; border: 2px solid #000; font-size: 10px; font-weight: 800; text-transform: uppercase; }
    .quiz-lock { margin-top: 16px; display: flex; align-items: center; gap: 8px; color: #6b7280; font-weight: 500; }

    .quiz-page { min-height: 100vh; padding-bottom: 100px; }
    .quiz-header { background: #fff; border-bottom: 3px solid #000; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
    .back-btn { display: flex; align-items: center; gap: 4px; font-weight: 700; background: none; border: none; cursor: pointer; }
    .back-btn:hover { text-decoration: underline; }
    .quiz-progress-indicator { background: #000; color: #fff; padding: 4px 12px; font-weight: 800; font-size: 14px; }
    .progress-bar { height: 4px; background: #e5e7eb; }
    .progress-bar-fill { height: 100%; background: #000; transition: width 0.3s ease; }
    .quiz-main { max-width: 672px; margin: 0 auto; padding: 16px; }
    .quiz-question-card { background: #fff; border: 3px solid #000; padding: 24px; margin-bottom: 24px; }
    .question-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .question-type { padding: 4px 8px; border: 2px solid #000; font-size: 12px; font-weight: 800; }
    .question-progress { font-size: 14px; color: #6b7280; font-weight: 500; }
    .question-text { font-size: 20px; font-weight: 700; line-height: 1.4; margin-bottom: 24px; }
    .options-list { display: flex; flex-direction: column; gap: 12px; }
    .option-btn { width: 100%; padding: 16px; text-align: left; font-weight: 500; display: flex; justify-content: space-between; align-items: center; border: 3px solid #000; background: #fff; cursor: pointer; font-family: inherit; font-size: 16px; transition: all 0.15s ease; }
    .option-btn:hover:not(:disabled) { background: #f9fafb; }
    .option-btn:disabled { cursor: default; }
    .option-btn.selected { background: #000; color: #fff; }
    .option-btn.selected .option-content { color: inherit; }
    .option-btn.correct { background: #dcfce7; border-color: #16a34a; color: #166534; }
    .option-btn.incorrect { background: #fee2e2; border-color: #dc2626; color: #991b1b; }
    .option-btn.disabled { opacity: 0.4; }
    .option-content { display: flex; align-items: center; gap: 12px; }
    .option-checkbox { width: 20px; height: 20px; border: 2px solid currentColor; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .checkbox-check { width: 12px; height: 12px; background: currentColor; }

    .rationale-box { margin-top: 16px; padding-top: 16px; border-top: 2px solid #000; }
    .rationale-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 12px; font-weight: 800; text-transform: uppercase; }
    .rationale-text { color: #374151; line-height: 1.6; font-style: italic; font-size: 14px; }

    .quiz-footer { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 3px solid #000; padding: 16px; z-index: 10; }
    .quiz-footer-inner { max-width: 672px; margin: 0 auto; display: flex; gap: 16px; }
    .nav-btn { flex: 1; padding: 12px; font-weight: 700; font-family: inherit; font-size: 16px; cursor: pointer; border: 3px solid #000; background: #fff; box-shadow: 4px 4px 0 0 #000; transition: all 0.15s ease; }
    .nav-btn:hover:not(:disabled) { box-shadow: 6px 6px 0 0 #000; transform: translate(-2px, -2px); }
    .nav-btn:active:not(:disabled) { box-shadow: 2px 2px 0 0 #000; transform: translate(2px, 2px); }
    .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .nav-btn.primary { background: #000; color: #fff; }
    .nav-btn.primary:hover:not(:disabled) { background: #222; }

    .result-page { min-height: 100vh; padding: 24px; display: flex; align-items: center; justify-content: center; }
    .result-card { background: #fff; border: 3px solid #000; box-shadow: 12px 12px 0 0 #000; padding: 32px; max-width: 400px; width: 100%; text-align: center; }
    .result-title { font-size: 24px; font-weight: 900; margin-bottom: 24px; text-transform: uppercase; letter-spacing: 0.1em; }
    .score-display { margin-bottom: 24px; }
    .score-number { font-size: 72px; font-weight: 900; }
    .score-total { font-size: 24px; color: #9ca3af; }
    .grade-text { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
    .grade-excellent { color: #16a34a; }
    .grade-good { color: #2563eb; }
    .grade-pass { color: #ca8a04; }
    .grade-fail { color: #dc2626; }
    .percentage-text { color: #6b7280; font-weight: 500; margin-bottom: 24px; }
    .result-actions { display: flex; flex-direction: column; gap: 12px; }
    .result-actions button { width: 100%; padding: 16px; font-weight: 700; font-size: 18px; font-family: inherit; cursor: pointer; border: 3px solid #000; box-shadow: 4px 4px 0 0 #000; transition: all 0.15s ease; }
    .result-actions button:hover { box-shadow: 6px 6px 0 0 #000; transform: translate(-2px, -2px); }
    .result-actions button.primary { background: #000; color: #fff; }
    .result-actions button.primary:hover { background: #222; }

    .icon-sm { width: 16px; height: 16px; }
    .icon-lg { width: 32px; height: 32px; }
    .icon-xl { width: 64px; height: 64px; }
    .text-green { color: #16a34a; }
    .text-red { color: #dc2626; }

    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 640px) {
      .home-title { font-size: 36px; }
      .quiz-grid { grid-template-columns: 1fr; }
      .quiz-card { padding: 20px; }
      .quiz-question-card { padding: 16px; }
      .question-text { font-size: 18px; }
      .score-number { font-size: 56px; }
      .result-card { padding: 24px; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // ==================== MathJax 渲染组件 ====================
    const MathJaxRenderer = ({ children, display = false }) => {
      const containerRef = React.useRef(null);
      const [mounted, setMounted] = React.useState(false);

      React.useEffect(() => {
        setMounted(true);
      }, []);

      React.useEffect(() => {
        if (!mounted || !containerRef.current || !children) return;

        const renderMathJax = async () => {
          // 等待MathJax准备好
          if (!window.MathJax) {
            setTimeout(renderMathJax, 100);
            return;
          }

          try {
            // 智能兼容：如果内容已经被 $ 或 $$ 包裹，自动去除，防止显示多余的定界符
            let latex = children || '';
            if (typeof latex === 'string') {
              if (latex.startsWith('$$') && latex.endsWith('$$')) {
                latex = latex.slice(2, -2);
              } else if (latex.startsWith('$') && latex.endsWith('$')) {
                latex = latex.slice(1, -1);
              }
            }

            // MathJax 3 API 最佳实践：传递纯 LaTeX 字符串，通过 options 控制显示模式
            const metrics = MathJax.getMetricsFor(containerRef.current);
            const options = { ...metrics, display: display };
            
            const svg = await MathJax.tex2svgPromise(latex, options);
            containerRef.current.innerHTML = '';
            containerRef.current.appendChild(svg);
          } catch (err) {
            // 如果渲染失败，显示原始文本
            console.debug('MathJax render failed, showing plain text:', err.message);
            containerRef.current.textContent = children;
          }
        };

        renderMathJax();
      }, [children, display, mounted]);

      return <span ref={containerRef} className="mathjax-content">{children}</span>;
    };

    // 包装文本内容，自动渲染其中的LaTeX
    const TextWithMath = ({ text }) => {
      // 检测是否包含LaTeX
      const hasLatex = /\$\$[\s\S]*?\$\$|\$[^$\n]+\$/.test(text);

      if (!hasLatex) {
        return <span>{text}</span>;
      }

      // 分割文本和LaTeX
      const parts = text.split(/(\$\$[\s\S]*?\$\$|\$[^$\n]+\$)/g);

      return (
        <span>
          {parts.map((part, i) => {
            if (part.startsWith('$$') && part.endsWith('$$')) {
              const formula = part.slice(2, -2);
              return <MathJaxRenderer key={i} display={true}>{formula}</MathJaxRenderer>;
            } else if (part.startsWith('$') && part.endsWith('$')) {
              const formula = part.slice(1, -1);
              return <MathJaxRenderer key={i} display={false}>{formula}</MathJaxRenderer>;
            }
            return <span key={i}>{part}</span>;
          })}
        </span>
      );
    };

    // ==================== 图标组件 ====================
    const CheckIcon = ({ className }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    );

    const XIcon = ({ className }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );

    const BackIcon = ({ className }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="19" y1="12" x2="5" y2="12"></line>
        <polyline points="12 19 5 12 12 5"></polyline>
      </svg>
    );

    const LockIcon = ({ className }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
      </svg>
    );

    const BookIcon = ({ className }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
      </svg>
    );

    const ChartIcon = ({ className }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="18" y1="20" x2="18" y2="10"></line>
        <line x1="12" y1="20" x2="12" y2="4"></line>
        <line x1="6" y1="20" x2="6" y2="14"></line>
      </svg>
    );

    // ==================== 组件 ====================
    function HomePage({ onSelectQuiz }) {
      const [quizList, setQuizList] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      const [error, setError] = React.useState(null);
      const [progressMap, setProgressMap] = React.useState({});

      React.useEffect(() => {
        fetch('data/quiz-list.json?t=' + Date.now())
          .then(res => {
            if (!res.ok) {
              throw new Error(`HTTP ${res.status}: 无法获取测验列表 (${res.url})`);
            }
            return res.json();
          })
          .then(data => {
            setQuizList(data);
            
            // 读取本地进度
            const newProgress = {};
            data.forEach(q => {
              try {
                const saved = localStorage.getItem(`quiz-progress-${q.id}`);
                if (saved) {
                  const p = JSON.parse(saved);
                  // 计算已答题数
                  const answered = p.selectedAnswers ? Object.keys(p.selectedAnswers).length : 0;
                  if (answered > 0) {
                    newProgress[q.id] = answered;
                  }
                }
              } catch (e) {
                console.warn('Failed to parse progress for', q.id);
              }
            });
            setProgressMap(newProgress);
            
            setLoading(false);
          })
          .catch(err => {
            console.error("Failed to load quiz list:", err);
            setError(err.message);
            setLoading(false);
          });
      }, []);

      if (loading) {
        return <div className="home-page" style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}>正在加载测验列表...</div>;
      }

      if (error) {
        return (
          <div className="home-page" style={{ padding: '24px', textAlign: 'center' }}>
            <div style={{ background: '#fee2e2', border: '3px solid #dc2626', padding: '16px', color: '#991b1b', fontWeight: 'bold' }}>
              加载失败: {error}
            </div>
            <button onClick={() => window.location.reload()} className="nav-btn" style={{ marginTop: '20px' }}>重试</button>
          </div>
        );
      }

      return (
        <div className="home-page">
          <header className="home-header">
            <h1 className="home-title">Quiz Hub</h1>
            <p className="home-subtitle">选择要开始的测验</p>
          </header>
          <main className="quiz-grid">
            {quizList.map((quiz) => {
              const progress = progressMap[quiz.id];
              const hasProgress = progress > 0 && progress < quiz.questionCount;
              
              return (
              <div
                key={quiz.id}
                className={`quiz-card ${quiz.locked ? 'locked' : ''}`}
                onClick={() => !quiz.locked && onSelectQuiz(quiz.id)}
              >
                <div className={`quiz-tag ${quiz.color}`}>
                  {quiz.questionCount > 0 ? `${quiz.questionCount} 题` : '即将推出'}
                </div>
                <h2 className="quiz-title">{quiz.title}</h2>
                <p className="quiz-desc">{quiz.description}</p>
                {quiz.tags && quiz.tags.length > 0 && (
                  <div className="quiz-tags">
                    {quiz.tags.map((tag, idx) => <span key={idx} className="tag">{tag}</span>)}
                  </div>
                )}
                {hasProgress && (
                  <div style={{ marginTop: '16px', display: 'flex', alignItems: 'center', gap: '8px', fontSize: '14px', fontWeight: 'bold', color: '#000' }}>
                    <div style={{ flex: 1, height: '6px', background: '#e5e7eb', border: '1px solid #000' }}>
                      <div style={{ width: `${(progress / quiz.questionCount) * 100}%`, height: '100%', background: '#4ade80' }}></div>
                    </div>
                    <span>{Math.round((progress / quiz.questionCount) * 100)}%</span>
                  </div>
                )}
                {quiz.locked && (
                  <div className="quiz-lock">
                    <LockIcon className="icon-sm" />
                    <span>锁定</span>
                  </div>
                )}
              </div>
            )})}
          </main>
        </div>
      );
    }

    function QuizCard({ question, index, total, onSelect, selectedAnswers, showRationale, isMultiConfirmed, onConfirmMulti, onShowRationale }) {
      if (!question) return null;

      const currentSelection = selectedAnswers ? selectedAnswers[question.id] : undefined;
      const isAnswered = question.isMultiple ? isMultiConfirmed : currentSelection !== undefined;
      const hasSelection = currentSelection && currentSelection.length > 0;

      const getOptionClass = (idx) => {
        let classes = 'option-btn';
        const isSelected = question.isMultiple ? currentSelection?.includes(idx) : currentSelection === idx;
        const correctAns = question.answer;
        const isCorrect = question.isMultiple ? correctAns.includes(idx) : correctAns === idx;

        if (isAnswered) {
          if (isCorrect) classes += ' correct';
          else if (isSelected && !isCorrect) classes += ' incorrect';
          else classes += ' disabled';
        } else {
          if (isSelected) classes += ' selected';
        }
        return classes;
      };

      const getIcon = (idx) => {
        if (!isAnswered) return null;
        const correctAns = question.answer;
        const isCorrect = question.isMultiple ? correctAns.includes(idx) : correctAns === idx;
        if (isCorrect) return <CheckIcon className="icon-sm text-green" />;
        if (currentSelection === idx && !isCorrect) return <XIcon className="icon-sm text-red" />;
        return null;
      };

      const isMultiChoice = question.isMultiple;
      const showConfirmBtn = isMultiChoice && hasSelection && !isMultiConfirmed;

      return (
        <div className="quiz-question-card">
          <div className="question-header">
            <span className="question-type">{isMultiChoice ? '不定项' : '单选'}</span>
            <span className="question-progress">{index + 1} / {total}</span>
          </div>
          <h3 className="question-text"><TextWithMath text={question.question} /></h3>
          <div className="options-list">
            {question.options.map((opt, idx) => (
              <button
                key={idx}
                onClick={() => !isAnswered && onSelect(idx)}
                disabled={isAnswered}
                className={getOptionClass(idx)}
              >
                <span className="option-content">
                  <span style={{ 
                    display: 'inline-flex', 
                    alignItems: 'center', 
                    justifyContent: 'center',
                    width: '24px',
                    height: '24px',
                    border: '2px solid currentColor',
                    marginRight: '12px',
                    fontSize: '12px',
                    fontWeight: 'bold',
                    flexShrink: 0
                  }}>
                    {idx + 1}
                  </span>
                  {isMultiChoice && (
                    <span className="option-checkbox">
                      {currentSelection?.includes(idx) && <span className="checkbox-check" />}
                    </span>
                  )}
                  <TextWithMath text={opt} />
                </span>
                {getIcon(idx)}
              </button>
            ))}
          </div>
          {showConfirmBtn && (
            <button onClick={onConfirmMulti} className="nav-btn primary" style={{ marginTop: '16px', width: '100%' }}>
              确认答案 (Enter)
            </button>
          )}
          {isAnswered && !showRationale && (
            <button onClick={onShowRationale} className="nav-btn" style={{ marginTop: '16px', width: '100%', fontSize: '14px', padding: '8px', boxShadow: '2px 2px 0 0 #000' }}>
              查看解析 (Enter)
            </button>
          )}
          {showRationale && (
            <div className="rationale-box animate-fade-in">
              <div className="rationale-header">
                <BookIcon className="icon-sm" />
                <span>解析</span>
              </div>
              <p className="rationale-text"><TextWithMath text={question.rationale} /></p>
            </div>
          )}
        </div>
      );
    }

    function ResultPage({ score, total, onRestart, onBack }) {
      const percentage = Math.round((score / total) * 100);
      let grade = '', gradeClass = '';
      if (percentage >= 90) { grade = '优秀'; gradeClass = 'grade-excellent'; }
      else if (percentage >= 70) { grade = '良好'; gradeClass = 'grade-good'; }
      else if (percentage >= 60) { grade = '及格'; gradeClass = 'grade-pass'; }
      else { grade = '需努力'; gradeClass = 'grade-fail'; }

      return (
        <div className="result-page">
          <div className="result-card">
            <ChartIcon className="icon-xl" />
            <h2 className="result-title">测验结果</h2>
            <div className="score-display">
              <span className="score-number">{score}</span>
              <span className="score-total"> / {total}</span>
            </div>
            <p className={`grade-text ${gradeClass}`}>{grade}</p>
            <p className="percentage-text">正确率 {percentage}%</p>
            <div className="result-actions">
              <button onClick={onRestart} className="primary">再测一次</button>
              <button onClick={onBack}>返回主页</button>
            </div>
          </div>
        </div>
      );
    }

    function QuizPage({ quizId, onBack }) {
      const [quiz, setQuiz] = React.useState(null);
      const [loading, setLoading] = React.useState(true);
      const [error, setError] = React.useState(null);
      const [currentIndex, setCurrentIndex] = React.useState(0);
      const [selectedAnswers, setSelectedAnswers] = React.useState({});
      const [showRationale, setShowRationale] = React.useState(false);
      const [score, setScore] = React.useState(0);
      const [isMultiConfirmed, setIsMultiConfirmed] = React.useState(false);
      const [hasSavedProgress, setHasSavedProgress] = React.useState(false);

      const STORAGE_KEY = `quiz-progress-${quizId}`;

      // 加载测验数据
      React.useEffect(() => {
        setLoading(true);
        setError(null);
        fetch(`data/${quizId}.json?t=${Date.now()}`)
          .then(res => {
            if (!res.ok) {
              throw new Error(`HTTP ${res.status}: 无法加载题目数据 (${res.url})`);
            }
            return res.json();
          })
          .then(data => {
            setQuiz(data);
            // 检查是否有保存的进度
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
              try {
                const progress = JSON.parse(saved);
                if (progress.currentIndex < data.questions.length) {
                  setCurrentIndex(progress.currentIndex);
                  setSelectedAnswers(progress.selectedAnswers || {});
                  setScore(progress.score || 0);
                  setHasSavedProgress(true);
                }
              } catch (e) {
                console.error("Failed to parse saved progress:", e);
              }
            }
            setLoading(false);
          })
          .catch(err => {
            console.error("Failed to load quiz data:", err);
            setError(err.message);
            setLoading(false);
          });
      }, [quizId]);

      // 保存进度到localStorage
      React.useEffect(() => {
        if (quiz && currentIndex >= 0) {
          const progress = {
            currentIndex,
            selectedAnswers,
            score,
            savedAt: Date.now()
          };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
        }
      }, [currentIndex, selectedAnswers, score, quiz]);

      // 派生状态
      const question = quiz?.questions?.[currentIndex];
      const isLastQuestion = quiz?.questions ? currentIndex === quiz.questions.length - 1 : false;

      // 动作处理函数
      const clearProgress = () => {
        localStorage.removeItem(STORAGE_KEY);
        setHasSavedProgress(false);
        setCurrentIndex(0);
        setSelectedAnswers({});
        setScore(0);
        setShowRationale(false);
        setIsMultiConfirmed(false);
      };

      const continueProgress = () => {
        setHasSavedProgress(false);
        if (question && selectedAnswers[question.id] !== undefined) {
          setShowRationale(true);
        }
      };

      const restart = () => {
        localStorage.removeItem(STORAGE_KEY);
        setCurrentIndex(0);
        setSelectedAnswers({});
        setShowRationale(false);
        setScore(0);
        setIsMultiConfirmed(false);
      };

      const handleMultiSelect = (idx) => {
        if (isMultiConfirmed || !question) return;
        const current = selectedAnswers[question.id] || [];
        const newSelection = current.includes(idx) ? current.filter(i => i !== idx) : [...current, idx];
        setSelectedAnswers({ ...selectedAnswers, [question.id]: newSelection });
      };

      const handleSingleSelect = (idx) => {
        if (selectedAnswers[question.id] !== undefined || !question) return;
        const isCorrect = idx === question.answer;
        setSelectedAnswers({ ...selectedAnswers, [question.id]: idx });
        setShowRationale(true); 
        if (isCorrect) setScore(s => s + 1);
      };

      const confirmMultiAnswer = () => {
        if (!question) return;
        const selection = selectedAnswers[question.id] || [];
        const isCorrect = selection.length > 0
          && selection.every(i => question.answer.includes(i))
          && selection.length === question.answer.length;
        setIsMultiConfirmed(true);
        setShowRationale(true); 
        if (isCorrect) setScore(s => s + 1);
      };

      const goNext = () => {
        if (isLastQuestion) {
          localStorage.removeItem(STORAGE_KEY);
          setCurrentIndex(-1);
        }
        else {
          const nextIdx = currentIndex + 1;
          const nextQ = quiz.questions[nextIdx];
          setCurrentIndex(nextIdx);
          setIsMultiConfirmed(nextQ && selectedAnswers[nextQ.id] !== undefined);
          setShowRationale(false); 
        }
      };

      const goPrev = () => {
        if (currentIndex > 0) {
          const prevIdx = currentIndex - 1;
          const prevQ = quiz.questions[prevIdx];
          setCurrentIndex(prevIdx);
          setIsMultiConfirmed(prevQ && selectedAnswers[prevQ.id] !== undefined);
          setShowRationale(false); 
        }
      };

      // 键盘控制支持 (现在在条件返回之前调用)
      React.useEffect(() => {
        const handleKeyDown = (e) => {
          // 如果正在加载、出错或完成，忽略键盘事件
          if (loading || error || hasSavedProgress || !quiz || currentIndex === -1) return;

          // 避免在输入框中触发
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

          if (!question) return;

          const hasSelection = selectedAnswers[question.id] !== undefined;
          const isLocked = question.isMultiple ? isMultiConfirmed : hasSelection;

          switch (e.key) {
            case 'ArrowLeft':
              e.preventDefault(); 
              goPrev();
              break;
            case 'ArrowRight':
              e.preventDefault();
              goNext();
              break;
            case 'Enter':
              e.preventDefault();
              if (question.isMultiple && !isMultiConfirmed && (selectedAnswers[question.id]?.length || 0) > 0) {
                 confirmMultiAnswer();
              } else if (isLocked && !showRationale) {
                 setShowRationale(true);
              } else {
                 goNext(); 
              }
              break;
            case '1': case '2': case '3': case '4': case '5': 
            case '6': case '7': case '8': case '9':
              const num = parseInt(e.key);
              if (num >= 1 && num <= question.options.length) {
                const idx = num - 1;
                if (!isLocked) {
                  if (question.isMultiple) {
                     handleMultiSelect(idx);
                  } else {
                     handleSingleSelect(idx);
                  }
                }
              }
              break;
          }
        };

        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [loading, error, hasSavedProgress, quiz, currentIndex, selectedAnswers, showRationale, isMultiConfirmed, question]);

      // ========== 渲染逻辑 (条件返回放在最后) ==========

      if (loading) {
        return <div className="quiz-page" style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}>正在加载试题...</div>;
      }

      if (error) {
        return (
          <div className="quiz-page" style={{ padding: '24px', textAlign: 'center' }}>
             <div style={{ background: '#fee2e2', border: '3px solid #dc2626', padding: '16px', color: '#991b1b', fontWeight: 'bold', marginBottom: '24px' }}>
              加载失败: {error}
            </div>
            <button onClick={onBack} className="nav-btn">返回主页</button>
          </div>
        );
      }

      if (!quiz) {
        return (
          <div style={{ padding: '40px', textAlign: 'center' }}>
            <p>测验内容为空</p>
            <button onClick={onBack} className="nav-btn" style={{ marginTop: '20px' }}>返回</button>
          </div>
        );
      }

      if (hasSavedProgress) {
        const answeredCount = Object.keys(selectedAnswers).length;
        const totalCount = quiz.questions.length;
        return (
          <div className="quiz-page" style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}>
            <div className="quiz-question-card" style={{ maxWidth: '400px', textAlign: 'center' }}>
              <h2 style={{ marginBottom: '16px' }}>检测到未完成的测验</h2>
              <p style={{ color: '#6b7280', marginBottom: '24px' }}>
                您已完成了 {answeredCount} / {totalCount} 道题
              </p>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                <button onClick={continueProgress} className="nav-btn primary">继续答题</button>
                <button onClick={clearProgress} className="nav-btn">重新开始</button>
              </div>
            </div>
          </div>
        );
      }

      if (currentIndex === -1) return <ResultPage score={score} total={quiz.questions.length} onRestart={restart} onBack={onBack} />;

      if (!question) {
        return <div style={{padding: '20px'}}>题目加载错误 (ID: {currentIndex}) <button onClick={restart}>重置</button></div>;
      }

      return (
        <div className="quiz-page">
          <header className="quiz-header">
            <button onClick={onBack} className="back-btn">
              <BackIcon className="icon-sm" /> 返回
            </button>
            <span className="quiz-progress-indicator">{currentIndex + 1} / {quiz.questions.length}</span>
          </header>
          <div className="progress-bar">
            <div className="progress-bar-fill" style={{ width: `${((currentIndex + 1) / quiz.questions.length) * 100}%` }} />
          </div>
          <main className="quiz-main">
            <QuizCard
              question={question}
              index={currentIndex}
              total={quiz.questions.length}
              onSelect={question.isMultiple ? handleMultiSelect : handleSingleSelect}
              selectedAnswers={selectedAnswers}
              showRationale={showRationale}
              isMultiConfirmed={isMultiConfirmed}
              onConfirmMulti={question.isMultiple ? confirmMultiAnswer : null}
              onShowRationale={() => setShowRationale(true)}
            />
            
            <div style={{ marginTop: '24px', padding: '12px', border: '2px dashed #9ca3af', borderRadius: '8px', fontSize: '12px', color: '#6b7280', display: 'flex', justifyContent: 'center', gap: '16px' }}>
              <span><kbd style={{ background: '#eee', padding: '2px 4px', border: '1px solid #999', borderRadius: '3px', color: '#000' }}>1-9</kbd> 选择选项</span>
              <span><kbd style={{ background: '#eee', padding: '2px 4px', border: '1px solid #999', borderRadius: '3px', color: '#000' }}>← / →</kbd> 上下题</span>
              <span><kbd style={{ background: '#eee', padding: '2px 4px', border: '1px solid #999', borderRadius: '3px', color: '#000' }}>Enter</kbd> 确认/解析</span>
            </div>
          </main>
          <footer className="quiz-footer">
            <div className="quiz-footer-inner">
              <button onClick={goPrev} disabled={currentIndex === 0} className="nav-btn">← 上一题</button>
              <button onClick={goNext} className="nav-btn primary">{isLastQuestion ? '查看结果 (Enter)' : '下一题 (Enter) →'}</button>
            </div>
          </footer>
        </div>
      );
    }

    function App() {
      const [currentView, setCurrentView] = React.useState('home');
      const [currentQuizId, setCurrentQuizId] = React.useState(null);

      const handleSelectQuiz = (quizId) => {
        setCurrentQuizId(quizId);
        setCurrentView('quiz');
      };

      const handleBackHome = () => {
        setCurrentView('home');
        setCurrentQuizId(null);
      };

      if (currentView === 'quiz' && currentQuizId) {
        return <QuizPage quizId={currentQuizId} onBack={handleBackHome} />;
      }
      return <HomePage onSelectQuiz={handleSelectQuiz} />;
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
